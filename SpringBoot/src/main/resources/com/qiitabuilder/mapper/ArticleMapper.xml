<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qiitabuilder.mapper.ArticleMapper">
    <select id="searchArticles" resultMap="articlesMap">
        select art.article_id as articleId,
        art.title as title,
        art.created_at as createdAt,
        art.updated_at as updatedAt,
        tags.tag_id as tagId,
        tags.tag_name as tagName,
        feed_cnt_table.feed_cnt as feedCnt,
        my_cnt_table.my_cnt as myCnt,
        recommend_cnt_table.recommend_cnt as recommendCnt,
        users.user_id as userId,
        users.display_name as displayName,
        users.photo_url as photoUrl
        from (select * from qiita_builder.articles limit #{search.pageSize} offset #{search.offset}) as art
        left outer join qiita_builder.articles_tags_relations as a_t_relation
        on art.article_id = a_t_relation.article_id
        left outer join qiita_builder.tags as tags on a_t_relation.tag_id = tags.tag_id
        left outer join (select article_id, count(feed.article_id) as feed_cnt
        from qiita_builder.feedbacks as feed
        group by feed.article_id) as feed_cnt_table
        on art.article_id = feed_cnt_table.article_id
        left outer join (select article_id, count(my.article_id) as my_cnt
        from qiita_builder.my_articles as my
        group by my.article_id) as my_cnt_table on art.article_id = my_cnt_table.article_id
        left outer join (select article_id, count(recommend.article_id) as recommend_cnt
        from qiita_builder.qiita_recommends as recommend
        group by recommend.article_id) as recommend_cnt_table
        on art.article_id = recommend_cnt_table.article_id
        left join qiita_builder.users on art.user_id = users.user_id
        <where>
            <if test="search.searchWord !=null">
                title like CONCAT('%', #{search.searchWord}, '%')
            </if>
            <if test="search.searchTag!=null">
                and tags.tag_id in
                <foreach item="tag" index="index" collection="search.searchTag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            </if>
            <if test="search.period!=null">
                <if test="search.period==0">
                    and created_at between NOW() - interval 7 day and NOW()
                </if>
                <if test="search.period==1">
                    and DATE_FORMAT(created_at, '%Y%m') = DATE_FORMAT(NOW(), '%Y%m')
                </if>
            </if>
        </where>
        order by ${search.sort}
    </select>

    <select id="getTotalPage" resultType="_int">
        select count(*)
        from qiita_builder.articles as art
        left outer join qiita_builder.articles_tags_relations as a_t_relation
        on art.article_id = a_t_relation.article_id
        left outer join qiita_builder.tags as tags on a_t_relation.tag_id = tags.tag_id
        left outer join (select article_id, count(feed.article_id) as feed_cnt
        from qiita_builder.feedbacks as feed
        group by feed.article_id) as feed_cnt_table
        on art.article_id = feed_cnt_table.article_id
        left outer join (select article_id, count(my.article_id) as my_cnt
        from qiita_builder.my_articles as my
        group by my.article_id) as my_cnt_table on art.article_id = my_cnt_table.article_id
        left outer join (select article_id, count(recommend.article_id) as recommend_cnt
        from qiita_builder.qiita_recommends as recommend
        group by recommend.article_id) as recommend_cnt_table
        on art.article_id = recommend_cnt_table.article_id
        left join qiita_builder.users on art.user_id = users.user_id
        <where>
            <if test="search.searchWord !=null">
                title like CONCAT('%', #{search.searchWord}, '%')
            </if>
            <if test="search.searchTag!=null">
                and tags.tag_id in
                <foreach item="tag" index="index" collection="search.searchTag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            </if>
            <if test="search.period!=null">
                <if test="search.period==0">
                    and created_at between NOW() - interval 7 day and NOW()
                </if>
                <if test="search.period==1">
                    and DATE_FORMAT(created_at, '%Y%m') = DATE_FORMAT(NOW(), '%Y%m')
                </if>
            </if>
        </where>
    </select>

    <resultMap id="articlesMap" type="com.qiitabuilder.domain.Article">
        <id column="articleId" property="articleId"/>
        <result column="title" property="title"/>
        <result column="createdAt" property="createdAt"/>
        <result column="updatedAt" property="updatedAt"/>
        <result column="feedCnt" property="feedbackCount"/>
        <result column="myCnt" property="registeredMyArticleCount"/>
        <result column="recommendCnt" property="qiitaRecommendPoint"/>
        <association property="postedUser" javaType="com.qiitabuilder.domain.User">
            <id column="userId" property="userId"/>
            <result column="displayName" property="displayName"/>
            <result column="photoUrl" property="photoUrl"/>
        </association>
        <collection property="tags" ofType="com.qiitabuilder.domain.Tag">
            <result column="tagId" property="tagId"/>
            <result column="tagName" property="tagName"/>
        </collection>
    </resultMap>
</mapper>
    <insert id="insertArticle" useGeneratedKeys="true" keyProperty="articleId">
        INSERT INTO articles(
        user_id,
        created_at,
        title,
        content,
        qiita_article_id,
        state_flag)
        VALUES (
        #{postedUser.userId},
        NOW(),
        #{title},
        #{content},
        #{qiitaArticleId},
        #{stateFlag})
      
      <selectKey resultType="Integer" keyProperty="articleId" order="AFTER">
            select @@IDENTITY
        </selectKey>
    </insert>
  
    <update id="updateArticle">
        UPDATE articles
        SET user_id          = #{postedUser.userId},
            updated_at       = NOW(),
            title            = #{title},
            content          = #{content},
            qiita_article_id = #{qiitaArticleId},
            state_flag       = #{stateFlag}
        WHERE article_id = #{articleId}
    </update>

    <select id="getPostedArticleCountRank" resultType="Integer">
        SELECT user_id
        FROM articles
        WHERE state_flag = 1 OR state_flag = 2
        GROUP BY user_id
        ORDER BY count(*) DESC;
    </select>

    <select id="getCountByUserId" resultType="Integer">
        SELECT count(*)
        FROM articles
        WHERE user_id = #{userId}
          AND (state_flag = 1 OR state_flag = 2);
    </select>

</mapper>

